<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistenti Digjital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        albania: {
                            red: '#E41E20', // National Flag Red
                            dark: '#0a0a0a', // Deep Black
                            charcoal: '#1a1a1a',
                            bubbleBot: '#262626',
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #050505; 
            color: #f5f5f5;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #E41E20; }
        
        /* Typing Animation */
        .typing-dot {
            animation: bounce 1.4s infinite ease-in-out both;
            background-color: #E41E20;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Subtle Pattern */
        .bg-pattern {
            background-image: radial-gradient(#E41E20 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.05;
        }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="h-screen flex flex-col overflow-hidden bg-albania-dark relative">

    <!-- Decorative Background -->
    <div class="absolute inset-0 bg-pattern pointer-events-none"></div>
    <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-red-900/20 rounded-full blur-[120px] pointer-events-none"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-red-900/10 rounded-full blur-[120px] pointer-events-none"></div>

    <!-- Header -->
    <header class="relative z-20 flex items-center justify-between px-4 sm:px-6 py-4 bg-albania-charcoal/80 backdrop-blur-xl border-b border-white/5 shadow-md">
        <div class="flex items-center gap-4">
            <div class="bg-albania-red p-2.5 rounded-lg shadow-[0_0_15px_rgba(228,30,32,0.4)] flex items-center justify-center">
                <!-- Eagle-like Icon representation -->
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M16 8a4 4 0 0 0-3.32-1.78l-1.38-2.74a1 1 0 0 0-1.6 0L8.32 6.22A4 4 0 0 0 5 10c0 2.21 1.79 4 4 4v6l3-3 3 3v-6a4 4 0 0 0 4-4Z"/></svg>
            </div>
            <div>
                <h1 class="font-bold text-white tracking-wide text-lg hidden sm:block">Asistenti Digjital</h1>
                <h1 class="font-bold text-white tracking-wide text-lg sm:hidden">Asistenti</h1>
                <p class="text-[11px] text-red-400 font-medium uppercase tracking-widest">Gjuha Shqipe</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button id="glossary-btn" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 transition-all text-xs sm:text-sm text-gray-300 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                UdhÃ«zues
            </button>
            <div class="flex items-center border-l border-white/10 pl-4">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse mr-2"></span>
                <span class="text-xs text-gray-400 hidden sm:inline">Online</span>
            </div>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="relative z-10 flex-1 overflow-y-auto px-4 sm:px-6 py-6 scroll-smooth">
        <div id="messages-list" class="max-w-3xl mx-auto flex flex-col justify-end min-h-0 pb-4">
            <!-- Messages injected via JS -->
        </div>
        
        <!-- Typing Indicator -->
        <div id="typing-indicator" class="hidden max-w-3xl mx-auto w-full mb-8 pl-2">
            <div class="flex items-end gap-3">
                <div class="bg-albania-bubbleBot border border-white/5 px-4 py-3 rounded-2xl rounded-bl-none flex items-center gap-1.5 shadow-lg">
                    <span class="w-1.5 h-1.5 rounded-full typing-dot"></span>
                    <span class="w-1.5 h-1.5 rounded-full typing-dot"></span>
                    <span class="w-1.5 h-1.5 rounded-full typing-dot"></span>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="relative z-20 p-4 bg-albania-charcoal/90 backdrop-blur-xl border-t border-white/5">
        <div class="max-w-3xl mx-auto">
            <form id="chat-form" class="relative flex items-center gap-3">
                <input 
                    id="user-input" 
                    type="text" 
                    placeholder="Shkruaj pÃ«rgjigjen tÃ«nde..." 
                    class="w-full bg-[#0F0F0F] text-gray-100 placeholder-gray-500 rounded-xl py-4 pl-5 pr-14 border border-white/10 focus:outline-none focus:ring-1 focus:ring-albania-red focus:border-albania-red transition-all shadow-inner font-light"
                    autocomplete="off"
                >
                <button 
                    type="submit" 
                    id="send-btn"
                    class="absolute right-2.5 p-2 bg-albania-red text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-[0_4px_14px_0_rgba(228,30,32,0.39)] hover:shadow-[0_6px_20px_rgba(228,30,32,0.23)] hover:-translate-y-0.5"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </form>
            <div class="text-center mt-3 flex justify-center items-center gap-2 opacity-30 hover:opacity-100 transition-opacity duration-300">
                <p class="text-[10px] text-gray-400 uppercase tracking-widest font-semibold">
                    Shkolla "Lasgush Poradeci"
                </p>
                <span class="text-red-500">â€¢</span>
                <p class="text-[10px] text-gray-400 font-serif italic">2026</p>
            </div>
        </div>
    </footer>

    <!-- Glossary Modal -->
    <div id="glossary-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Background backdrop -->
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="glossary-backdrop"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div id="glossary-panel" class="relative transform overflow-hidden rounded-2xl bg-[#1a1a1a] border border-white/10 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 scale-95">
                    <div class="bg-albania-red/10 px-4 py-3 sm:px-6 border-b border-white/10 flex justify-between items-center">
                        <h3 class="text-lg font-semibold leading-6 text-white flex items-center gap-2" id="modal-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
                            UdhÃ«zues Gramatikor
                        </h3>
                        <button id="close-glossary" class="text-gray-400 hover:text-white transition-colors p-1 rounded-md hover:bg-white/5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
                        </button>
                    </div>
                    <div class="px-4 py-5 sm:p-6 max-h-[60vh] overflow-y-auto custom-scroll">
                        <div id="glossary-content" class="space-y-4">
                            <!-- Terms will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Constants ---
        const INITIAL_MESSAGE_TEXT = "BashkÃ« mund tÃ« komunikojmÃ« vetÃ«m nÃ« gjuhÃ«n shqipe. A dÃ«shiron tÃ« vazhdojmÃ«?";
        
        const MOTIVATIONAL_QUOTES = [
            "TÃ« gjitha Ã«ndrrat tona mund tÃ« bÃ«hen realitet nÃ«se kemi guximin t'i ndjekim ato.",
            "E vetmja mÃ«nyrÃ« pÃ«r tÃ« bÃ«rÃ« punÃ« tÃ« madhe Ã«shtÃ« ta duash atÃ« qÃ« bÃ«n.",
            "Nuk ka rÃ«ndÃ«si sa ngadalÃ« ecÃ«n, pÃ«r sa kohÃ« qÃ« nuk ndalon.",
            "BÃ«hu ndryshimi qÃ« dÃ«shiron tÃ« shohÃ«sh nÃ« botÃ«.",
            "Ã‡do ditÃ« Ã«shtÃ« njÃ« mundÃ«si e re pÃ«r tÃ« qenÃ« mÃ« i mirÃ« se dje.",
            "Dielli lind sÃ«rish pas Ã§do stuhie."
        ];

        // Structured Data for Interactive Flow
        const SYNTAX_DATA = {
            kryefjala: {
                keywords: ["kryefjala", "kryefjal"],
                def: "<strong>Kryefjala</strong> Ã«shtÃ« gjymtyra kryesore e fjalisÃ« qÃ« shÃ«non frymorin a sendin i cili kryen veprimin ose qÃ« ka tiparin e shprehur nga kallÃ«zuesi.",
                shprehet: "<strong>Kryefjala shprehet:</strong><br>a) me <strong>emÃ«r</strong> â€“ <em>Shiu vazhdonte tÃ« binte lehtÃ« e gÃ«zueshÃ«m.</em><br>b) me <strong>pÃ«remÃ«r</strong> â€“ <em>LirinÃ« nuk ua solla unÃ«, po e gjeta nÃ« mes jush.</em><br>c) me <strong>grup emÃ«ror</strong> â€“ <em>Midis reve, herÃ« pas here ndriÃ§onte tokÃ«n dielli pranveror.</em><br>d) me <strong>pjesÃ« tÃ« nÃ«nrenditur ftilluese</strong> â€“ <em>Mendohet se ky qytet Ã«shtÃ« njÃ« vendbanim i lashtÃ«.</em>",
                llojet: null, 
                question: "A dÃ«shiron tÃ« dish se me Ã§farÃ« shprehet?"
            },
            kallezuesi: {
                keywords: ["kallÃ«zuesi", "kallezuesi", "kallÃ«zues", "kallezues"],
                def: "<strong>KallÃ«zuesi</strong> Ã«shtÃ« gjymtyra kryesore e fjalisÃ« qÃ« tregon njÃ« veprim a njÃ« gjendje tÃ« kryefjalÃ«s.",
                llojet: "<strong>Klasifikimi i kallÃ«zuesve sipas mÃ«nyrÃ«s sÃ« shprehjes:</strong><br>a) <strong>KallÃ«zues emÃ«ror</strong> â€“ <em>Ai Ã«shtÃ« njeri i besÃ«s.</em><br>b) <strong>KallÃ«zues i thjeshtÃ« foljor</strong> â€“ <em>Drita e mÃ«ngjesit po mbulonte tokÃ«n e pÃ«rgjumur.</em><br>c) <strong>KallÃ«zues i pÃ«rbÃ«rÃ« foljor</strong> â€“ <em>Ajo filloi tÃ« shkruante librin e parÃ«.</em>",
                shprehet: "<strong>MÃ«nyra e formimit:</strong><br>â€¢ <strong>KallÃ«zues emÃ«ror:</strong> folja â€˜jam/Ã«shtÃ«- kÃ«pujaâ€™ + gjymtyra emÃ«rore â€˜njeri i besÃ«sâ€™ (GE).<br>â€¢ <strong>KallÃ«zues i thjeshtÃ« foljor:</strong> folje nÃ« kohÃ«t e thjeshta ose kohÃ« tÃ« pÃ«rbÃ«ra.<br>â€¢ <strong>KallÃ«zues i pÃ«rbÃ«rÃ« foljor:</strong> folje aspektore (filloj, zÃ«, nis...) ose folje modale (mund, duhet, do) + folje nÃ« lidhore, forma tÃ« pashtjelluara ose emra prejfoljor asnjanÃ«s.",
                question: "A dÃ«shiron tÃ« dish llojet apo me Ã§farÃ« shprehet?"
            },
            percaktori: {
                keywords: ["pÃ«rcaktori", "percaktori", "pÃ«rcaktor", "percaktor"],
                def: "<strong>PÃ«rcaktori</strong> Ã«shtÃ« gjymtyrÃ« e dytÃ« e fjalisÃ«, pjesÃ« e grupit emÃ«ror.",
                llojet: "<strong>Llojet e pÃ«rcaktorÃ«ve:</strong><br>1. PÃ«rcaktori me pÃ«rshtatje.<br>2. PÃ«rcaktori me drejtim.<br>3. PÃ«rcaktori me bashkim.",
                shprehet: "<strong>1. PÃ«rcaktori me pÃ«rshtatje shprehet:</strong><br>a) me mbiemÃ«r â€“ <em>Uji po rridhte me njÃ« zhurmÃ« ritmike.</em><br>b) me pÃ«remÃ«r â€“ <em>Motra e saj fliste aq bukur!</em><br>c) me numÃ«ror â€“ <em>Ata janÃ« tre shokÃ« tÃ« mirÃ«.</em><br><br><strong>2. PÃ«rcaktori me drejtim shprehet:</strong><br>a) Me emÃ«r nÃ« rasÃ«n emÃ«rore me parafjalÃ« â€“ <em>Vajza nga Tirana fitoi vendin e parÃ« nÃ« konkurs.</em><br>b) Me emÃ«r nÃ« rasÃ«n gjinore â€“ <em>Vargu i njerÃ«zve nuk kishte tÃ« mbaruar.</em><br>c) Me emÃ«r nÃ« rasÃ«n kallÃ«zore â€“ <em>NÃ« mbrÃ«mje shijova njÃ« gotÃ« verÃ« me miqtÃ« e mi.</em><br>d) Me emÃ«r nÃ« rasÃ«n rrjedhore â€“ <em>Ajo dukej e brishtÃ« si njÃ« gotÃ« kristali.</em><br><br><strong>3. PÃ«rcaktori me bashkim shprehet:</strong><br>a) me formÃ« tÃ« pashtjelluar pjesore â€“ <em>Dy aktorÃ« mbuluar me pelerina filluan tÃ« dialogonin.</em><br>b) me formÃ« tÃ« pashtjelluar paskajore â€“ <em>DÃ«shira pÃ«r tÃ« studiuar ishte e ethshme.</em><br>c) me ndajfolje â€“ <em>Klasa pÃ«rballÃ« Ã«shtÃ« e motrÃ«s sime.</em>",
                question: "A dÃ«shiron tÃ« dish llojet apo me Ã§farÃ« shprehet?"
            },
            kundrinori: {
                keywords: ["kundrinori", "kundrinor"],
                def: "<strong>Kundrinori</strong> Ã«shtÃ« gjymtyrÃ« e dytÃ« qÃ« tregon objektin mbi tÃ« cilin bie veprimi i foljes.",
                llojet: "<strong>Llojet:</strong><br>â€¢ Kundrinor i drejtÃ« (pa parafjalÃ«).<br>â€¢ Kundrinor i zhdrejtÃ« (me ose pa parafjalÃ«).",
                shprehet: "<strong>Shprehet me:</strong><br>â€¢ EmÃ«r, pÃ«remÃ«r ose grup emÃ«ror.",
                question: "A dÃ«shiron tÃ« dish llojet apo me Ã§farÃ« shprehet?"
            }
        };

        const GLOSSARY_TERMS = [
            { term: "Sintaksa", def: "PjesÃ« e gramatikÃ«s qÃ« studion ndÃ«rtimin e fjalive dhe marrÃ«dhÃ«niet mes fjalÃ«ve." },
            { term: "Kryefjala", def: "GjymtyrÃ« kryesore qÃ« tregon kush e kryen veprimin ose pÃ«r kÃ« flitet nÃ« fjali." },
            { term: "KallÃ«zuesi", def: "GjymtyrÃ« kryesore qÃ« tregon veprimin apo gjendjen e kryefjalÃ«s." },
            { term: "Kundrinori", def: "GjymtyrÃ« e dytÃ« mbi tÃ« cilÃ«n bie veprimi i foljes." },
            { term: "PÃ«rcaktori", def: "GjymtyrÃ« e dytÃ« qÃ« shÃ«rben pÃ«r tÃ« pÃ«rcaktuar (cilÃ«suar) emrin bÃ«rthamÃ«." },
            { term: "Rrethanori", def: "GjymtyrÃ« e dytÃ« qÃ« tregon rrethanÃ«n e kryerjes sÃ« veprimit (kohÃ«, vend, mÃ«nyrÃ« etj.)." },
            { term: "Folja", def: "PjesÃ« e ligjÃ«ratÃ«s qÃ« tregon veprim ose gjendje (psh: <em>punoj, jam</em>)." },
            { term: "Emri", def: "PjesÃ« e ligjÃ«ratÃ«s qÃ« emÃ«rton frymorÃ«, sende, vende ose dukuri (psh: <em>Tirana, djalÃ«</em>)." },
            { term: "Mbiemri", def: "PjesÃ« e ligjÃ«ratÃ«s qÃ« tregon njÃ« cilÃ«si tÃ« emrit (psh: <em>i bukur, e lartÃ«</em>)." }
        ];

        // --- State Management ---
        // 0: Initial Question
        // 1: Intermediate Question ("A deshiron te vazhdojme me pyetjet?")
        // 2: Ask for something beautiful ("Me thuaj nje gje te bukur") - from Step 1 refusal
        // 3: Quiz Mode
        // 4: Finished/Restarting
        // 5: Refusal Path (User said NO to initial question) -> "DÃ«shiron tÃ« ndash..."
        // 6: Listening Mode (User said YES to "DÃ«shiron tÃ« ndash...")
        let step = 0; 
        let activeTopic = null;
        let subContext = null; 
        let isTyping = false;

        // --- DOM Elements ---
        const messagesList = document.getElementById('messages-list');
        const typingIndicator = document.getElementById('typing-indicator');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatContainer = document.getElementById('chat-container');

        // Modal Elements
        const glossaryBtn = document.getElementById('glossary-btn');
        const glossaryModal = document.getElementById('glossary-modal');
        const glossaryBackdrop = document.getElementById('glossary-backdrop');
        const glossaryPanel = document.getElementById('glossary-panel');
        const closeGlossaryBtn = document.getElementById('close-glossary');
        const glossaryContent = document.getElementById('glossary-content');

        // --- Logic: Greetings ---
        function getGreeting() {
            const h = new Date().getHours();
            if (h >= 5 && h < 12) return "MirÃ«mÃ«ngjes";
            if (h >= 12 && h < 18) return "MirÃ«dita";
            return "MirÃ«mbrÃ«ma";
        }

        function getFullIntro() {
            return `<strong class="text-red-400 text-lg">${getGreeting()}!</strong><br>${INITIAL_MESSAGE_TEXT}`;
        }

        // --- Init ---
        window.onload = () => {
            // Populate Glossary
            renderGlossary();

            // Initial delay for realism
            setTimeout(() => {
                appendMessage('bot', getFullIntro());
            }, 500);
            userInput.focus();
        };

        // --- Event Listeners ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text || isTyping || step === 4) return;

            // User Message
            appendMessage('user', text);
            userInput.value = '';
            
            // Bot Response Flow
            processBotResponse(text);
        });

        // Glossary Listeners
        glossaryBtn.addEventListener('click', openGlossary);
        closeGlossaryBtn.addEventListener('click', closeGlossary);
        glossaryBackdrop.addEventListener('click', closeGlossary);

        function openGlossary() {
            glossaryModal.classList.remove('hidden');
            setTimeout(() => {
                glossaryBackdrop.classList.remove('opacity-0');
                glossaryPanel.classList.remove('opacity-0', 'scale-95');
                glossaryPanel.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        function closeGlossary() {
            glossaryBackdrop.classList.add('opacity-0');
            glossaryPanel.classList.add('opacity-0', 'scale-95');
            glossaryPanel.classList.remove('opacity-100', 'scale-100');
            setTimeout(() => {
                glossaryModal.classList.add('hidden');
            }, 300);
        }

        function renderGlossary() {
            glossaryContent.innerHTML = GLOSSARY_TERMS.map((item, index) => `
                <div class="p-3 bg-white/5 rounded-lg border border-white/5 hover:border-red-500/30 transition-colors group">
                    <h4 class="text-red-400 font-bold mb-1 group-hover:text-red-300 transition-colors">${item.term}</h4>
                    <p class="text-gray-300 text-sm leading-relaxed">${item.def}</p>
                </div>
            `).join('');
        }

        // --- Core Logic ---
        async function processBotResponse(userText) {
            showTyping(true);
            
            // Artificial delay based on text length
            const delay = 1000 + Math.random() * 800;
            await new Promise(r => setTimeout(r, delay));

            const lowerText = userText.toLowerCase();
            const isPositive = lowerText === 'po' || lowerText.includes('po ') || lowerText.includes(' po') || lowerText.includes('sigurisht');
            
            // Enhanced Refusal Logic
            const isRefusal = lowerText === 'jo' || 
                            lowerText.includes('jo ') || 
                            lowerText.includes(' jo') || 
                            lowerText.includes('s\'dua') || 
                            lowerText.includes('nuk dua') || 
                            lowerText.includes('nuk kam deshire') ||
                            lowerText.includes('nuk kam dÃ«shirÃ«') ||
                            lowerText.includes('nuk dua te flas') ||
                            lowerText.includes('nuk dua tÃ« flas') ||
                            lowerText.includes('nuk dua te tregoj') ||
                            lowerText.includes('nuk dua tÃ« tregoj');

            let response = "";

            // Logic Tree
            if (step === 0) {
                // Initial Question: "A dÃ«shiron tÃ« vazhdojmÃ«?"
                if (isPositive) {
                    // Go to Intermediate Question
                    step = 1; 
                    response = "MÃ« vjen mirÃ«. A dÃ«shiron tÃ« vazhdojmÃ« me pyetjet?";
                } else {
                    // "Jo" -> New Refusal Logic
                    step = 5; 
                    response = "E kuptoj. DÃ«shiron tÃ« ndash me mua njÃ« gjÃ« tÃ« bukur qÃ« tÃ« ka ndodhur sot?";
                }
            }
            else if (step === 5) {
                // User replying to "Deshiron te ndash me mua...?"
                if (isPositive) {
                    step = 6;
                    response = "Po tÃ« dÃ«gjoj. TÃ« lutem mÃ« trego. ğŸ‘‚";
                } else {
                    // Refusal 2
                    step = 4; // End
                    const quote = MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)];
                    response = `E kuptoj heshtjen tÃ«nde. NdonjÃ«herÃ« fjalÃ«t nuk janÃ« tÃ« nevojshme.<br><br>
                                <em class="block mb-2">"${quote}"</em><br>
                                <strong>UnÃ« jam kÃ«tu nÃ« Ã§do moment pÃ«r tÃ« tÃ« ndihmuar.</strong>`;
                    setTimeout(initiateAutoRestart, 2500);
                }
            }
            else if (step === 6) {
                // User is telling the story
                step = 4; // End
                const quote = MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)];
                
                response = `Sa gjÃ« e bukur! MÃ« vjen mirÃ« qÃ« e ndave kÃ«tÃ« moment me mua. Ã‹shtÃ« vÃ«rtet frymÃ«zuese. ğŸ¤<br><br>
                            <em class="block mb-2">"${quote}"</em><br>
                            <strong>UnÃ« jam kÃ«tu nÃ« Ã§do moment pÃ«r tÃ« tÃ« ndihmuar.</strong>`;
                setTimeout(initiateAutoRestart, 2500);
            }
            else if (step === 1) {
                // Intermediate: "A dÃ«shiron tÃ« vazhdojmÃ« me pyetjet?"
                if (isPositive) {
                    // Go to Quiz Logic
                    step = 3; 
                    response = "ShkÃ«lqyeshÃ«m! Mund tÃ« mÃ« pyesÃ«sh rreth <strong>sintaksÃ«s sÃ« gjuhÃ«s shqipe</strong>.";
                } else {
                    // "Jo" -> Old Empathy Path
                    step = 2; 
                    response = "MirÃ«. AtÃ«herÃ« mÃ« thuaj njÃ« gjÃ« tÃ« bukur qÃ« tÃ« ka ndodhur sot?";
                }
            }
            else if (step === 3) {
                // QUIZ MODE
                
                // Check stop words
                if (lowerText.includes('mjaft') || lowerText.includes('stop') || lowerText.includes('jo') || lowerText.includes('faleminderit')) {
                    step = 2;
                    activeTopic = null;
                    subContext = null;
                    response = "KÃ«naqÃ«si tÃ« bisedonim pÃ«r gjuhÃ«n! AtÃ«herÃ« mÃ« thuaj njÃ« gjÃ« tÃ« bukur qÃ« tÃ« ka ndodhur sot?";
                } 
                else {
                    // 1. Check for New Topic (High Priority)
                    let newTopicKey = null;
                    for (const key in SYNTAX_DATA) {
                        if (SYNTAX_DATA[key].keywords.some(k => lowerText.includes(k))) {
                            newTopicKey = key;
                            break;
                        }
                    }

                    if (newTopicKey) {
                        activeTopic = newTopicKey;
                        subContext = null; // Reset context for new topic
                        const data = SYNTAX_DATA[newTopicKey];
                        response = `${data.def}<br><br><span class="text-red-300 italic">${data.question}</span>`;
                    } 
                    else if (activeTopic) {
                        // Handle interactions within the active topic
                        const data = SYNTAX_DATA[activeTopic];
                        const isAffirmation = lowerText === 'po' || lowerText.includes('po ') || lowerText.includes(' po') || lowerText.includes('sigurisht') || lowerText.includes('dua');
                        const isNegation = lowerText === 'jo' || lowerText.includes('jo ') || lowerText.includes(' jo') || lowerText.includes('nuk') || lowerText.includes('tjeter');

                        if (isNegation) {
                            // Exit current topic
                            activeTopic = null;
                            subContext = null;
                            response = "NÃ« rregull. Mund tÃ« vazhdojmÃ« me elemente tÃ« tjera tÃ« sintaksÃ«s (KallÃ«zuesi, PÃ«rcaktori, Kundrinori). PÃ«r cilÃ«n dÃ«shiron tÃ« dish mÃ« shumÃ«?";
                        }
                        else if (lowerText.includes('lloj') || lowerText.includes('klasifikim')) {
                            // User asks for Types
                            response = data.llojet ? data.llojet : "PÃ«r kÃ«tÃ« gjymtyrÃ« nuk kemi klasifikim llojesh.";
                            
                            // Check for follow-up potential
                            if (data.shprehet && subContext !== 'shprehet') {
                                response += "<br><br><span class='text-red-300 italic'>A dÃ«shiron tÃ« dish gjithashtu se me Ã§farÃ« shprehet?</span>";
                                subContext = 'llojet'; // Mark that we just discussed types
                                // Active topic remains
                            } else {
                                activeTopic = null;
                                subContext = null;
                                response += "<br><br>DÃ«shiron tÃ« pyesÃ«sh pÃ«r ndonjÃ« gjymtyrÃ« tjetÃ«r?";
                            }
                        } 
                        else if (lowerText.includes('shpreh') || lowerText.includes('formo') || lowerText.includes('behet')) {
                            // User asks for Expression
                            response = data.shprehet ? data.shprehet : "MÃ« fal, nuk kam informacion specifik pÃ«r shprehjen e saj.";

                            // Check for follow-up potential
                            if (data.llojet && subContext !== 'llojet') {
                                response += "<br><br><span class='text-red-300 italic'>A dÃ«shiron tÃ« dish gjithashtu llojet?</span>";
                                subContext = 'shprehet'; // Mark that we just discussed expression
                            } else {
                                activeTopic = null;
                                subContext = null;
                                response += "<br><br>DÃ«shiron tÃ« pyesÃ«sh pÃ«r ndonjÃ« gjymtyrÃ« tjetÃ«r?";
                            }
                        }
                        else if (isAffirmation) {
                            // User says "Po" to the previous prompt
                            if (subContext === 'llojet' && data.shprehet) {
                                response = data.shprehet;
                                activeTopic = null; // Finished both
                                subContext = null;
                                response += "<br><br>DÃ«shiron tÃ« pyesÃ«sh pÃ«r ndonjÃ« gjymtyrÃ« tjetÃ«r?";
                            }
                            else if (subContext === 'shprehet' && data.llojet) {
                                response = data.llojet;
                                activeTopic = null;
                                subContext = null;
                                response += "<br><br>DÃ«shiron tÃ« pyesÃ«sh pÃ«r ndonjÃ« gjymtyrÃ« tjetÃ«r?";
                            }
                            else {
                                // Fallback general affirmation (show everything or whatever is left)
                                if (data.llojet && data.shprehet) {
                                    response = data.llojet + "<br><br>" + data.shprehet;
                                } else if (data.llojet) {
                                    response = data.llojet;
                                } else {
                                    response = data.shprehet;
                                }
                                activeTopic = null;
                                subContext = null;
                                response += "<br><br>DÃ«shiron tÃ« pyesÃ«sh pÃ«r ndonjÃ« gjymtyrÃ« tjetÃ«r?";
                            }
                        }
                        else {
                            // Input didn't match keywords inside active topic
                            response = "MÃ« fal, nuk tÃ« kuptova qartÃ«. A dÃ«shiron tÃ« dish <strong>llojet</strong>, <strong>me Ã§farÃ« shprehet</strong>, apo tÃ« flasim pÃ«r njÃ« gjymtyrÃ« tjetÃ«r?";
                        }
                    } else {
                        // No active topic and no new topic found
                        response = `Nuk tÃ« kuptova qartÃ«. Mund tÃ« pyesÃ«sh pÃ«r:
                                    <span class="text-red-400">KryefjalÃ«n</span>, 
                                    <span class="text-red-400">KallÃ«zuesin</span>, 
                                    <span class="text-red-400">PÃ«rcaktorin</span> ose 
                                    <span class="text-red-400">Kundrinorin</span>.`;
                    }
                }
            } 
            else if (step === 2) {
                // EMPATHY RESPONSE (Input to "Tell me something beautiful" from Step 1)
                step = 4; // Finished state
                const quote = MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)];
                
                if (isRefusal) {
                    response = `E kuptoj heshtjen tÃ«nde. NdonjÃ«herÃ« fjalÃ«t nuk janÃ« tÃ« nevojshme. ğŸ¤<br><br>
                                <em class="block mb-2">"${quote}"</em>
                                <br><strong>UnÃ« jam kÃ«tu nÃ« Ã§do moment pÃ«r tÃ« tÃ« ndihmuar.</strong>`;
                } else {
                    response = `Sa gjÃ« e bukur! Faleminderit qÃ« e ndave kÃ«tÃ« moment me mua. ğŸ¤<br><br>
                                <em class="block mb-2">"${quote}"</em>
                                <br><strong>UnÃ« jam kÃ«tu nÃ« Ã§do moment pÃ«r tÃ« tÃ« ndihmuar.</strong>`;
                }
                
                setTimeout(initiateAutoRestart, 2500);
            }

            showTyping(false);
            appendMessage('bot', response);
        }

        // --- Restart Logic ---
        function initiateAutoRestart() {
            userInput.disabled = true;
            userInput.placeholder = "Biseda po rifillon...";
            document.getElementById('send-btn').classList.add('opacity-50');

            setTimeout(() => {
                messagesList.style.opacity = '0';
                messagesList.style.transition = 'opacity 0.5s ease';
                
                setTimeout(() => {
                    messagesList.innerHTML = '';
                    messagesList.style.opacity = '1';
                    step = 0;
                    activeTopic = null;
                    subContext = null;
                    userInput.disabled = false;
                    userInput.placeholder = "Shkruaj pÃ«rgjigjen tÃ«nde...";
                    userInput.value = '';
                    document.getElementById('send-btn').classList.remove('opacity-50');
                    
                    appendMessage('bot', getFullIntro());
                }, 500);
            }, 7000);
        }

        // --- UI Helper Functions ---
        function appendMessage(sender, htmlText) {
            const isBot = sender === 'bot';
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full mb-6 animate-slide-up ${isBot ? 'justify-start' : 'justify-end'}`;

            const inner = document.createElement('div');
            inner.className = `flex max-w-[85%] md:max-w-[70%] ${isBot ? 'flex-row' : 'flex-row-reverse'} items-end gap-3`;

            const avatar = document.createElement('div');
            avatar.className = `flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center shadow-lg ${isBot ? 'bg-albania-charcoal border border-white/10 text-red-500' : 'bg-albania-red text-white'}`;
            avatar.innerHTML = isBot 
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';

            const bubble = document.createElement('div');
            bubble.className = `px-5 py-3.5 rounded-2xl text-[15px] leading-relaxed shadow-md transition-all ${
                isBot 
                ? 'bg-albania-bubbleBot text-gray-100 rounded-bl-none border border-white/5' 
                : 'bg-albania-red text-white rounded-br-none shadow-red-900/20'
            }`;
            
            const content = document.createElement('div');
            content.innerHTML = htmlText;

            bubble.appendChild(content);
            inner.appendChild(avatar);
            inner.appendChild(bubble);
            wrapper.appendChild(inner);

            messagesList.appendChild(wrapper);
            scrollToBottom();
        }

        function showTyping(show) {
            isTyping = show;
            if (show) {
                typingIndicator.classList.remove('hidden');
                scrollToBottom();
            } else {
                typingIndicator.classList.add('hidden');
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
